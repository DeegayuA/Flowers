<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌷</text></svg>">
  <title>For You</title>
  <link rel="stylesheet" href="./style.css">

</head>

<body class="not-loaded">
  <div class="night"></div>
  <div class="flowers" style="display: none;">
    <div class="flower flower--1">
      <div class="flower__leafs flower__leafs--1">
        <div class="flower__leaf flower__leaf--1"></div>
        <div class="flower__leaf flower__leaf--2"></div>
        <div class="flower__leaf flower__leaf--3"></div>
        <div class="flower__leaf flower__leaf--4"></div>
        <div class="flower__white-circle"></div>

        <div class="flower__light flower__light--1"></div>
        <div class="flower__light flower__light--2"></div>
        <div class="flower__light flower__light--3"></div>
        <div class="flower__light flower__light--4"></div>
        <div class="flower__light flower__light--5"></div>
        <div class="flower__light flower__light--6"></div>
        <div class="flower__light flower__light--7"></div>
        <div class="flower__light flower__light--8"></div>

      </div>
      <div class="flower__line">
        <div class="flower__line__leaf flower__line__leaf--1"></div>
        <div class="flower__line__leaf flower__line__leaf--2"></div>
        <div class="flower__line__leaf flower__line__leaf--3"></div>
        <div class="flower__line__leaf flower__line__leaf--4"></div>
        <div class="flower__line__leaf flower__line__leaf--5"></div>
        <div class="flower__line__leaf flower__line__leaf--6"></div>
      </div>
    </div>

    <div class="flower flower--2">
      <div class="flower__leafs flower__leafs--2">
        <div class="flower__leaf flower__leaf--1"></div>
        <div class="flower__leaf flower__leaf--2"></div>
        <div class="flower__leaf flower__leaf--3"></div>
        <div class="flower__leaf flower__leaf--4"></div>
        <div class="flower__white-circle"></div>

        <div class="flower__light flower__light--1"></div>
        <div class="flower__light flower__light--2"></div>
        <div class="flower__light flower__light--3"></div>
        <div class="flower__light flower__light--4"></div>
        <div class="flower__light flower__light--5"></div>
        <div class="flower__light flower__light--6"></div>
        <div class="flower__light flower__light--7"></div>
        <div class="flower__light flower__light--8"></div>

      </div>
      <div class="flower__line">
        <div class="flower__line__leaf flower__line__leaf--1"></div>
        <div class="flower__line__leaf flower__line__leaf--2"></div>
        <div class="flower__line__leaf flower__line__leaf--3"></div>
        <div class="flower__line__leaf flower__line__leaf--4"></div>
      </div>
    </div>

    <div class="flower flower--3">
      <div class="flower__leafs flower__leafs--3">
        <div class="flower__leaf flower__leaf--1"></div>
        <div class="flower__leaf flower__leaf--2"></div>
        <div class="flower__leaf flower__leaf--3"></div>
        <div class="flower__leaf flower__leaf--4"></div>
        <div class="flower__white-circle"></div>

        <div class="flower__light flower__light--1"></div>
        <div class="flower__light flower__light--2"></div>
        <div class="flower__light flower__light--3"></div>
        <div class="flower__light flower__light--4"></div>
        <div class="flower__light flower__light--5"></div>
        <div class="flower__light flower__light--6"></div>
        <div class="flower__light flower__light--7"></div>
        <div class="flower__light flower__light--8"></div>

      </div>
      <div class="flower__line">
        <div class="flower__line__leaf flower__line__leaf--1"></div>
        <div class="flower__line__leaf flower__line__leaf--2"></div>
        <div class="flower__line__leaf flower__line__leaf--3"></div>
        <div class="flower__line__leaf flower__line__leaf--4"></div>
      </div>
    </div>

    <div class="grow-ans" style="--d:1.2s">
      <div class="flower__g-long">
        <div class="flower__g-long__top"></div>
        <div class="flower__g-long__bottom"></div>
      </div>
    </div>

    <div class="growing-grass">
      <div class="flower__grass flower__grass--1">
        <div class="flower__grass--top"></div>
        <div class="flower__grass--bottom"></div>
        <div class="flower__grass__leaf flower__grass__leaf--1"></div>
        <div class="flower__grass__leaf flower__grass__leaf--2"></div>
        <div class="flower__grass__leaf flower__grass__leaf--3"></div>
        <div class="flower__grass__leaf flower__grass__leaf--4"></div>
        <div class="flower__grass__leaf flower__grass__leaf--5"></div>
        <div class="flower__grass__leaf flower__grass__leaf--6"></div>
        <div class="flower__grass__leaf flower__grass__leaf--7"></div>
        <div class="flower__grass__leaf flower__grass__leaf--8"></div>
        <div class="flower__grass__overlay"></div>
      </div>
    </div>

    <div class="growing-grass">
      <div class="flower__grass flower__grass--2">
        <div class="flower__grass--top"></div>
        <div class="flower__grass--bottom"></div>
        <div class="flower__grass__leaf flower__grass__leaf--1"></div>
        <div class="flower__grass__leaf flower__grass__leaf--2"></div>
        <div class="flower__grass__leaf flower__grass__leaf--3"></div>
        <div class="flower__grass__leaf flower__grass__leaf--4"></div>
        <div class="flower__grass__leaf flower__grass__leaf--5"></div>
        <div class="flower__grass__leaf flower__grass__leaf--6"></div>
        <div class="flower__grass__leaf flower__grass__leaf--7"></div>
        <div class="flower__grass__leaf flower__grass__leaf--8"></div>
        <div class="flower__grass__overlay"></div>
      </div>
    </div>

    <div class="grow-ans" style="--d:2.4s">
      <div class="flower__g-right flower__g-right--1">
        <div class="leaf"></div>
      </div>
    </div>

    <div class="grow-ans" style="--d:2.8s">
      <div class="flower__g-right flower__g-right--2">
        <div class="leaf"></div>
      </div>
    </div>

    <div class="grow-ans" style="--d:2.8s">
      <div class="flower__g-front">
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--1">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--2">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--3">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--4">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--5">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--6">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--7">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__leaf-wrapper flower__g-front__leaf-wrapper--8">
          <div class="flower__g-front__leaf"></div>
        </div>
        <div class="flower__g-front__line"></div>
      </div>
    </div>

    <div class="grow-ans" style="--d:3.2s">
      <div class="flower__g-fr">
        <div class="leaf"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--1"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--2"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--3"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--4"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--5"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--6"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--7"></div>
        <div class="flower__g-fr__leaf flower__g-fr__leaf--8"></div>
      </div>
    </div>

    <div class="long-g long-g--0">
      <div class="grow-ans" style="--d:3s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:2.2s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:3.4s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:3.6s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--1">
      <div class="grow-ans" style="--d:3.6s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:3.8s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:4s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:4.2s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--2">
      <div class="grow-ans" style="--d:4s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:4.2s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:4.4s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:4.6s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--3">
      <div class="grow-ans" style="--d:4s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:4.2s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:3s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:3.6s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--4">
      <div class="grow-ans" style="--d:4s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:4.2s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:3s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:3.6s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--5">
      <div class="grow-ans" style="--d:4s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:4.2s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:3s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:3.6s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--6">
      <div class="grow-ans" style="--d:4.2s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:4.4s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:4.6s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:4.8s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>

    <div class="long-g long-g--7">
      <div class="grow-ans" style="--d:3s">
        <div class="leaf leaf--0"></div>
      </div>
      <div class="grow-ans" style="--d:3.2s">
        <div class="leaf leaf--1"></div>
      </div>
      <div class="grow-ans" style="--d:3.5s">
        <div class="leaf leaf--2"></div>
      </div>
      <div class="grow-ans" style="--d:3.6s">
        <div class="leaf leaf--3"></div>
      </div>
    </div>
  </div>

  <div id="welcome-message"
    style="display: none; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1003; color: white; font-size: 1.2em; padding: 20px; background-color: rgba(0, 0, 0, 0.7); border-radius: 10px;">
  </div>
  <!-- Name Input and Greeting -->
  <div id="name-input-container">
    <input type="text" id="name-input" placeholder="Enter your name">
    <button id="name-submit">Submit</button>
  </div>

  <div id="greeting-container"></div>

  <!-- Quote Container -->
  <div class="quote-container"></div>

  <!-- Start Button (for returning users) -->
  <button id="start-button" class="start-button">Start</button>

  <div class="feedback-buttons">
    <button id="love-button">Love</button>
    <button id="nah-button">Nah</button>
  </div>

  <div id="view-count"
    style="position: absolute; top: 10px; right: 20px; color: white; text-align: right; font-size: 1.5rem; z-index: 1001;"></div>

  <audio id="calming-sound" src="./audio.mp3" preload="auto"></audio>
</body>
<script src="./script.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics.js";
  import { getDatabase, ref, set, update, onValue, increment, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js"; // Corrected import

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC2b69qVhHnr5ojqOs_L01JbbaRPOLZH0A",
    authDomain: "flowers-d77d6.firebaseapp.com",
    databaseURL: "https://flowers-d77d6-default-rtdb.asia-southeast1.firebasedatabase.app", // Make sure this is correct for your region.
    projectId: "flowers-d77d6",
    storageBucket: "flowers-d77d6.firebasestorage.app",
    messagingSenderId: "57527363623",
    appId: "1:57527363623:web:f116bccbabed0909d84602",
    measurementId: "G-RZC5X7R92L"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  // Gemini API Key
  const apiKey = "AIzaSyDZ8Ese2f3byhBx0t2zN3P_gwrDPUCHrv4"; // Replace with your actual API key

  let currentUserIP = null;
  let currentVisitId = null;
  let userName = null;

  document.getElementById("start-button").addEventListener("click", function () {
    this.classList.add("fade-out");

    // Optional: Hide the button after animation completes
    setTimeout(() => {
      this.style.display = "none";
    }, 500);
  });


  function setRandomFlowerColor() {
    const hue = Math.floor(Math.random() * 360);
    const color1 = `hsl(${hue}, 70%, 80%)`;
    const color2 = `hsl(${hue}, 80%, 50%)`;
    document.documentElement.style.setProperty('--flower-color', color1);
    document.documentElement.style.setProperty('--flower-gradient-top', color2);
  }

  async function getQuote(name) {
    try {
      const prompt = `Generate a heartfelt Sinhala greeting for my girlfriend based on the current time (${new Date().toLocaleTimeString()}). Include:
      - A warm greeting in Sinhala.
      - The translated version of the given username "${name}" in Sinhala.
      - A short excerpt from a romantic Sinhala song (few lines) released between 2020 and 2025 by a young Sri Lankan artist.
      The output should be entirely in Sinhala and formatted as follows, no english texts:
      
      [Short but Warm, lovely Greeting] [Translated Name]! \n
      [Romantic Song lyrics (few lines)] [emojis]`;
      
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
        }),
      });

      if (!response.ok) {
        if (response.status === 429) {
          console.warn("Rate limit exceeded. Using default quote.");
          return `Hey ${name}! AI was not in the mood now, Try Later`;
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      }

      const data = await response.json();

      if (data.candidates && data.candidates.length > 0) { // Simplified check
        const candidate = data.candidates[0];
        if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
          return candidate.content.parts[0].text;
        } else if (candidate.content && typeof candidate.content === 'string') { // Check for direct string content
          return candidate.content;
        } else {
          console.error("Unexpected response structure:", data);
          return `Hey ${name}! How are you?`;
        }
      } else {
        console.error("Unexpected response structure:", data);
        return `Hey ${name}! How are you?`;
      }

    } catch (error) {
      console.error("Error fetching quote:", error);
      return `Hey ${name}! How are you?`;
    }
  }
  const calmingSound = document.getElementById('calming-sound');

  // Function to toggle play/pause and update button text/icon
  function togglePlayPause() {
    if (calmingSound.paused) {
      calmingSound.play().catch(error => console.warn("Autoplay failed. User interaction may be required.", error));
      playPauseButton.innerHTML = '❚❚'; // Pause icon (Unicode)
      playPauseButton.setAttribute('aria-label', 'Pause Music');
    } else {
      calmingSound.pause();
      playPauseButton.innerHTML = '▶'; // Play icon (Unicode)
      playPauseButton.setAttribute('aria-label', 'Play Music');
    }
  }

  // Create the play/pause button
  const playPauseButton = document.createElement('button');
  playPauseButton.classList.add('play-pause-button'); // Add class for styling
  playPauseButton.innerHTML = '▶'; // Default icon
  playPauseButton.setAttribute('aria-label', 'Play Music');
  playPauseButton.addEventListener('click', togglePlayPause);

  // Try autoplay with reduced volume
  calmingSound.volume = 0.6;
  calmingSound.play().then(() => {
    playPauseButton.innerHTML = '❚❚'; // Set to pause icon if autoplay succeeds
    playPauseButton.setAttribute('aria-label', 'Pause Music');
  }).catch(error => console.warn("Autoplay blocked. Waiting for user interaction.", error));

  // Create and position the button container
  const buttonContainer = document.createElement('div');
  buttonContainer.classList.add('sound-button-container'); // Specific class for styling
  buttonContainer.style.zIndex = '1002';
  buttonContainer.appendChild(playPauseButton);
  document.body.appendChild(buttonContainer);

  async function getUserName() {
    return new Promise(async (resolve) => {
      const nameInput = document.getElementById('name-input');
      const submitButton = document.getElementById('name-submit');
      const nameInputContainer = document.getElementById('name-input-container');
      const startButton = document.getElementById('start-button');
      const welcomeMessage = document.getElementById('welcome-message');
      
      // Check for saved name in localStorage
      let userName = localStorage.getItem('userName');
      
      if (userName) {
        nameInputContainer.style.display = 'none'; // Hide name input
        startButton.style.display = 'block'; // Show start button
        startButton.textContent = "Loading...";
  
        // Fetch dynamic message on load
        const userVisits = await getUserVisits(userName);
        startButton.textContent = getDynamicMessage(userVisits);
        
        startButton.addEventListener('click', () => {
          startButton.classList.add('fade-out');
          setTimeout(() => startButton.style.display = 'none', 500);
          showGreetingAndQuote(userName);
          togglePlayPause();
          resolve(userName);
        });
      } else {
        // Show input field for new users
        nameInputContainer.style.display = 'block';
        submitButton.addEventListener('click', async () => {
          let inputName = nameInput.value.trim();
          if (!inputName) {
            try {
              const ipResponse = await fetch('https://api.ipify.org?format=json');
              const ipData = await ipResponse.json();
              inputName = "Anonymous_" + ipData.ip.replace(/\./g, '_');
            } catch (error) {
              console.error("Error fetching IP:", error);
              inputName = 'Anonymous';
            }
          }
  
          userName = inputName;
          localStorage.setItem('userName', userName);
          nameInputContainer.style.opacity = 0;
          setTimeout(() => {
            nameInputContainer.style.display = 'none';
          }, 500);
  
          // Show welcome message for first-time users
          welcomeMessage.textContent = `Welcome! Refresh the page for new poems and flowers. Enjoy!`;
          welcomeMessage.style.display = 'block';
          
          setTimeout(() => {
            welcomeMessage.style.display = 'none';
            showGreetingAndQuote(userName);
            togglePlayPause();
            resolve(userName);
          }, 3000); // Display for 3 seconds
        });
      }
    });
  }
  
  async function showGreetingAndQuote(name) {
    const greetingContainer = document.getElementById('greeting-container');
    const quote = await getQuote(name);
  
    document.title = `For You, ${name}!`;
    document.querySelector('.flowers').style.display = 'block';
    setRandomFlowerColor(); // Initial flower color
    document.querySelector('.quote-container').textContent = quote;
    document.querySelector('.quote-container').style.display = 'block';
  
    const loveButton = document.getElementById('love-button');
    const nahButton = document.getElementById('nah-button');
    let feedbackCounts = { love: 0, nah: 0 }; // Initialize local counts
  
    // No onValue listener here. We initialize and update locally.
  
    // Helper function to generate emoji string (remains the same)
    function getEmojiString(emoji, count) {
        if (count <= 10) {
            return emoji.repeat(count);
        } else {
          return `${emoji} x${count}`;
        }
    }
      //update the button text with the local counts
     function updateButtonText() {
      loveButton.textContent = `Love ${getEmojiString('❤️', feedbackCounts.love)}`;
      nahButton.textContent = `Nah ${getEmojiString('😔', feedbackCounts.nah)}`;
    }
  
    // Initialize button text
      updateButtonText();
  
    setTimeout(async () => {
      document.querySelector('.quote-container').style.opacity = 1;
      document.querySelector('.feedback-buttons').style.display = 'flex';
  
      const visitId = await logVisit(userName, quote);
      await updateViewCount(userName);
  
        document.querySelector('.feedback-buttons').addEventListener('click', async (event) => { // Async event listener
        const clickedButton = event.target;
        if (clickedButton.id === 'love-button' || clickedButton.id === 'nah-button') {
            clickedButton.classList.add('clicked');
            clickedButton.addEventListener('animationend', () => {
                clickedButton.classList.remove('clicked');
            }, { once: true });
  
            // Update local counts
            if (clickedButton.id === 'love-button') {
                feedbackCounts.love++;
            } else {
                feedbackCounts.nah++;
            }
  
            // Update button text with new counts
            updateButtonText();
          //   console.log(feedbackCounts);
  
            // Update Firebase (both feedbackCounts and visits)
            await handleFeedback(clickedButton.id === 'love-button' ? 'love' : 'nah', visitId); // Await the update
  
            // Change flower color with fade
            setRandomFlowerColor(); // Call the function to set new color.
              const flowersElement = document.querySelector('.flowers'); // Get flowers element
              flowersElement.style.transition = 'scale 6s ease-out'; // Set up transition
              flowersElement.style.scale = 0;                                        // Fade out
  
            setTimeout(() => {
                setRandomFlowerColor(); // Set new random color
                flowersElement.style.scale = 1; // Fade back in with new colors
            }, 300); //  delay to match the fade-out duration
  
        }
      });
  
    }, 500);
  }
  //logVisit function to include visit data
  async function logVisit(userName, quote) {
    const visitRef = push(ref(db, 'visits'));
    currentVisitId = visitRef.key;
    const visitData = {
      userId: userName,
      ip: currentUserIP,
      timestamp: serverTimestamp(),
      quote: quote,
      loveCount: 0,
      nahCount: 0
    };
    await set(visitRef, visitData);

    // Log device info *after* creating the visit
    await logDeviceInfo(currentUserIP, userName, quote, currentVisitId);

    return currentVisitId;
  }

  async function getUserVisits(userId) {
    const visitsRef = ref(db, 'visits');
    return new Promise((resolve, reject) => {
      onValue(visitsRef, (snapshot) => {
        const visitsData = snapshot.val();
        const userVisits = [];
  
        if (visitsData) {
          for (const key in visitsData) {
            // Use the provided userId for filtering, *not* a hardcoded or global value
            if (visitsData[key].userId === userId) {
              userVisits.push(visitsData[key]);
            }
          }
        }
        userVisits.sort((a, b) => b.timestamp - a.timestamp);
        resolve(userVisits);
      }, (error) => {
        reject(error);
      });
    });
  }

  function getDynamicMessage(visits) {
    const now = Date.now();
    const oneHour = 60 * 60 * 1000;
    const oneDay = 24 * oneHour;
    const oneWeek = 7 * oneDay;
  
    let message = "ආයේ කවි කියවන්න ආවාද බබා 🥰🩵"; // Default
  
    if (visits.length === 0) {
      return "අලුතෙන් ආවට සාදරයෙන් පිලිගන්නවා 🥰🩵";
    }
  
    const lastVisitTime = visits[0].timestamp;
    const timeSinceLastVisit = now - lastVisitTime;
  
    if (timeSinceLastVisit < oneHour) {
      let recentVisits = 0;
      for (const visit of visits) {
        if (now - visit.timestamp < oneHour) {
          recentVisits++;
        } else {
          break;  // Optimization:  Visits are sorted, so we can stop.
        }
      }
      message = `${Math.ceil(recentVisits / 2)} පාරක් ආවා නේද මේ පැයේ 🥰🩵`;
    } else if (timeSinceLastVisit < oneDay) {
      message = "අද ආයේ ආවද?  🥰🩵";
    } else if (timeSinceLastVisit < oneWeek) {
      message = "සතියකට පස්සේ හම්බුනේ 🥰🩵";
    } else {
      message = "Wow, ගොඩ කාලෙකින් ආවේ 🥰🩵";
    }
    return message;
  }
  

  document.getElementById('start-button').addEventListener('click', async () => {
    const userId = localStorage.getItem('userName') || "Anonymous";

    try { // Wrap in a try...catch for error handling
      const userVisits = await getUserVisits(userId); // Pass the userId
      const message = getDynamicMessage(userVisits);
      const ipAddress = await getIpAddress(); // Get the IP address

      const newVisitRef = push(ref(db, 'visits'));
      await set(newVisitRef, { // Use await here, too
        ip: ipAddress, // Store the IP address
        loveCount: 0,
        nahCount: 0,
        quote: "new quote",
        timestamp: serverTimestamp(),
        userId: userId
      });

      document.getElementById('start-button').textContent = message;

    } catch (error) {
      console.error("Error:", error);
      document.getElementById('start-button').textContent = "Error loading data. Please try again."; // User-friendly error message
    }
  });

  // --- Device Info Functions ---
  async function getDeviceInfo() {
    let deviceInfo = {};
  
    // IP Address
    deviceInfo.ipAddress = await getIpAddress();
  
    // User Agent (Browser, OS)
    deviceInfo.userAgent = navigator.userAgent;
  
    // Device Type
    deviceInfo.deviceType = /Mobile|iP(hone|od|ad)|Android|BlackBerry|IEMobile|Kindle|NetFront|Silk-Accelerated|(hpw|web)OS|Fennec|Minimo|Opera M(obi|ini)|Blazer|Dolfin|Dillo|Silk|Skyfire/.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
  
    // Screen Size
    deviceInfo.screenWidth = window.screen.width;
    deviceInfo.screenHeight = window.screen.height;
  
    // Viewport Size
    deviceInfo.viewportWidth = window.innerWidth;
    deviceInfo.viewportHeight = window.innerHeight;
  
    // Language
    deviceInfo.language = navigator.language || navigator.userLanguage;
  
    // Online Status
    deviceInfo.isOnline = navigator.onLine;
  
      // Battery Status (if available - limited browser support)
      if ('getBattery' in navigator) {
          try {
              const battery = await navigator.getBattery();
              deviceInfo.batteryLevel = battery.level;
              deviceInfo.isCharging = battery.charging;
              // Handle Infinity/NaN values and undefined
              deviceInfo.chargingTime = (battery.chargingTime !== undefined && isFinite(battery.chargingTime)) ? battery.chargingTime : null;
              deviceInfo.dischargingTime = (battery.dischargingTime !== undefined && isFinite(battery.dischargingTime)) ? battery.dischargingTime : null;
  
          } catch (batteryError) {
              console.error("Error getting battery info:", batteryError);
              deviceInfo.batteryStatus = 'Not available';
          }
      } else {
          deviceInfo.batteryStatus = 'Not supported';
      }
  
      // Device Orientation (if available)
      if ('orientation' in window.screen) {
          deviceInfo.orientation = window.screen.orientation.type;
      } else {
          deviceInfo.orientation = 'Not supported';
      }
  
    // Network Information (Connection Type - limited browser support, experimental)
    if ('connection' in navigator) {
      const connection = navigator.connection;
      deviceInfo.effectiveConnectionType = connection.effectiveType;
      // Handle potentially undefined values
      deviceInfo.downlinkMax = (connection.downlinkMax !== undefined && isFinite(connection.downlinkMax)) ? connection.downlinkMax : null;
      deviceInfo.rtt = (connection.rtt !== undefined && isFinite(connection.rtt)) ? connection.rtt : null;
      deviceInfo.saveData = connection.saveData;
      if (connection.type) {
        deviceInfo.connectionType = connection.type;
      }
    } else {
      deviceInfo.networkInfo = 'Not supported';
    }
  
    // Location information using ipinfo.io
    try {
      const locationResponse = await fetch(`https://ipinfo.io/${deviceInfo.ipAddress}/json?token=a656d399b8381d`);//add token
      const locationData = await locationResponse.json();
  
      // Check for errors from ipinfo.io
      if (locationData.error) {
        console.warn("Error from ipinfo.io:", locationData.error.message || locationData.error);
        deviceInfo.location = { status: 'Location service error' };
      }
      else
      {
        deviceInfo.location = {
          city: locationData.city,
          region: locationData.region,
          country: locationData.country,
          loc: locationData.loc, // Latitude and longitude as a single string
          postal: locationData.postal,
          timezone: locationData.timezone,
          org: locationData.org // ISP information
        };
      }
    } catch (error) {
      console.error("Error getting location from ipinfo.io:", error);
      deviceInfo.location = { status: 'Location service failed' };
    }
  
    return deviceInfo;
  }
  
    // Helper function to sanitize data for Firebase
    function sanitizeDataForFirebase(data) {
      if (typeof data === 'object' && data !== null) {
        const newData = Array.isArray(data) ? [] : {};
        for (const key in data) {
          if (data.hasOwnProperty(key)) {
            newData[key] = sanitizeDataForFirebase(data[key]); // Recursively sanitize
          }
        }
        return newData;
      } else if (typeof data === 'number' && !isFinite(data)) {
        // Replace Infinity and NaN with null
        return null;
      } else if (data === undefined) { // Add this check for undefined
          return null;
      }
       else {
        return data;
      }
    }
  async function logDeviceInfo(ipAddress, userId, quote, visitId) {
    const deviceInfo = await getDeviceInfo();
    deviceInfo.userId = userId;
    deviceInfo.lastVisitId = visitId;
    deviceInfo.lastQuote = quote;
    deviceInfo.lastVisitTimestamp = serverTimestamp();
  
    deviceInfo.totalVisits = deviceInfo.totalVisits || 0;
    deviceInfo.totalLoveCount = deviceInfo.totalLoveCount || 0;
    deviceInfo.totalNahCount = deviceInfo.totalNahCount || 0;
  
      // Sanitize the deviceInfo before attempting to store it.
      const sanitizedDeviceInfo = sanitizeDataForFirebase(deviceInfo);
  
  
    const deviceInfoRef = ref(db, `deviceInfo/${ipAddress.replace(/\./g, '_')}`);
    try {
      await update(deviceInfoRef, {
        ...sanitizedDeviceInfo, // Use the sanitized data
        totalVisits: increment(1),
      });
      console.log("Device info and visit count logged/updated successfully.");
    } catch (error) {
      console.error("Error logging device info and visit count:", error);
      const errorRef = push(ref(db, 'errors'));
      try {
        await set(errorRef, {
          timestamp: serverTimestamp(),
          error: error.message,
          type: "deviceInfoUpdate",
          userId: userId,
          ipAddress: ipAddress,
          visitId: visitId,
          // Log the sanitized data, as that's what caused the original error
          deviceInfo: sanitizedDeviceInfo,
        });
        console.log("Error details logged successfully.");
      } catch (errorLogErr) {
        console.error("Failed to log the error itself!", errorLogErr);
      }
    }
  }

  
  async function handleFeedback(feedbackType, visitId) {
    if (!visitId || !currentUserIP) { // Check for both visitId and currentUserIP
      console.error("Visit ID or IP address is not available.");
      return;
    }

    const ipKey = currentUserIP.replace(/\./g, '_');
    const deviceInfoRef = ref(db, `deviceInfo/${ipKey}`);
    //added
    const feedbackRef = ref(db, `feedbackCounts/${ipKey}`);

    try {
      if (feedbackType === 'love') {
        await update(deviceInfoRef, { totalLoveCount: increment(1) });
        // Also update the visit-specific loveCount
        await set(ref(db, `visits/${visitId}/loveCount`), increment(1));
          //added
          await update(feedbackRef, { love: increment(1) });

      } else if (feedbackType === 'nah') {
        await update(deviceInfoRef, { totalNahCount: increment(1) });
        // Also update the visit-specific nahCount
        await set(ref(db, `visits/${visitId}/nahCount`), increment(1));
          //added
          await update(feedbackRef, { nah: increment(1) });
      }
      console.log("Feedback and counts updated successfully.");
    } catch (error) {
      console.error("Error updating feedback and counts:", error);
    }
  }
  //updateViewCount Function
  async function updateViewCount(userName) {
    const userRef = ref(db, `users/${userName}`);
    onValue(userRef, (snapshot) => {
      const userData = snapshot.val() || { totalViews: 0 };
      const totalViews = userData.totalViews;
      const viewCountElement = document.getElementById('view-count');
      if (viewCountElement) {
        viewCountElement.textContent = `Total Views: ${totalViews + 1}`;
      }
    }, { onlyOnce: false });
    await set(ref(db, `users/${userName}/totalViews`), increment(1));
  }
  // Get user's IP address (using a third-party service - ipify)
  async function getIpAddress() {
    try {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      return data.ip;
    } catch (error) {
      console.error("Error getting IP address:", error);
      return 'unknown'; // Fallback IP
    }
  }
  async function init() {
    try {
      onload = () => {
        const c = setTimeout(() => {
          document.body.classList.remove("not-loaded");
          setRandomFlowerColor();
          clearTimeout(c);
        }, 1000);
      };

      currentUserIP = await getIpAddress();
      if (currentUserIP === "unknown") {
        console.warn("Could not retrieve IP address.");
      }

      userName = await getUserName();

      // Moved logDeviceInfo call to showGreetingAndQuote
    } catch (error) {
      console.error("Error during initialization:", error);
    }
  }

  document.addEventListener('DOMContentLoaded', init);
</script>

</html>